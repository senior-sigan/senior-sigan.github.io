<!DOCTYPE html>
<html lang="">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Защита личных данных пользователя в браузерах</title>
  <meta name="description" content="" />
  <!-- Yandex.Metrika counter -->
<meta name="yandex-verification" content="721d8d42ba7b40bb" />
<script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();
    for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
    k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
 
    ym(91297055, "init", {
         clickmap:true,
         trackLinks:true,
         accurateTrackBounce:true
    });
 </script>
 <noscript><div><img src="https://mc.yandex.ru/watch/91297055" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
 <!-- /Yandex.Metrika counter -->

  <link rel="stylesheet" href="/styles/index.css">
  <link rel="stylesheet" href="/styles/katex.min.css">
</head>

<body>
  <header>
    <div class="logo">
      <a href="/">
        <pre class="ascii-art">
          ####***************+==:.  .:=+**###**-..:.....=*+-*********************=-::::+*****************=********
          ********************+=:. .:=+*##*:==......::=*-:****************#*+::.....-==********:-******#**********
          ....-=+****************+-+*##%*-:::::.:....--:=*###*********#*+:::::-:::::+*###**=:.:=**#***#***********
          ----**##********###*****##%%%=::=....:-#%%#*=-:-+*#*#*#*#*#+=---:::....:===-::......:*+=*###************
          %%%%%%%%#########*#*#####%%#-...  :##%%*#%#-.....:=*####*-.......:---=**+=-:::......=::=*#**#*#*#*#*#***
          %%%%%%%######*#*#*#####%%*=:.... .******=:..........::==:.......   . :*%%%#**:::=*-...:***#****#*#*#*###
          %%%%%#########*#######*-:::::.....:::::.::..................... .+%%%%%%%%%=. .::.    :-+***##*###*#*###
          %%%%#%#####**#*####*=::::-:::.........::-::.................... :******++: ........:-+****#*##%####*#***
          %%%%%**+*+:+***#***::.::::::.......::::..........................::::..........::+***#*###%%%###########
          ---::::..  .::-=+*=..............::*%%%%%%%##**+==--::::...................:::=*######%%%%##*#######%%%%
          ---===-:::.:+####*+:.............:=%%%%%%%%%%%%%%%%%%%%*:..........:::::-+******+*%%%%%#********#%%%%%%%
          +++=:::::::=%%%###*-:............:#%%%%%%%%%%%%%%%%%%%%+:........:::::::::::::+%%%%#******+=-.:=****#%%%
          :::::::::-#%%%%####*=::.:......:.:*%#**++===++***#%%%%*:.........:::::::::=*#####*#*#*****#*=..::::::***
        </pre>
      </a>
    </div>

    <table>
      <tbody>
        <tr>
          <td style="width: 33%;"><a href="/teaching">Курсы</a></td>
          <td style="width: 33%;"><a href="/notes">Заметки</a></td>
          <td style="width: 33%;"><a href="/talks">Выступления</a></td>
        </tr>
      </tbody>
    </table>
  </header>

  <div>
    <main>
<article>
  <div>
    <h1>Защита личных данных пользователя в браузерах</h1>
    <time datetime="2015-05-07">07 May 2015</time>
  </div>

  <div id="notes-entry-container">
    <content>
      <blockquote>
<p>Проблема — это не проблема, пока её никто не увидел.</p>
</blockquote>
<p><a href="https://developer.mozilla.org/en-US/Firefox">Firefox</a>, <a href="http://dev.chromium.org/Home">Chromium</a>, explorer, safari, opera-vivaldi, yandex browser — Это лишь только самые популярные браузеры, а есть еще целая куча других и форков этих. Не известно зачем так много их нужно, но каждый из них что-то делает лучше, хотя бы выглядят по-разному, и как-то по своему интерпретирует стандарты web. В плане безопасности все они решают одну проблему — сделать так, чтобы какой-то сторонний сайт не получил контроль над вашим компьютером через браузер. С другой же стороны, иногда необходимо дать некоторые права до реальной операционной системы или железа web-приложениям, например до камеры, gps и т.д.</p>
<p>Балансируя на разрешениях/ограничениях все вендоры решают только эту сторону безопасности браузеров, игнорируя защиту локальных данных пользователя. Я решил изучить этот вопрос и узнать, что происходит именно в этой области безопасности современных браузеров.</p>
<p>Все браузеры хранят пользовательские закладки, историю посещений, кэш, пароли, кукис, файлы web-sql, indexedDB и прочее. Где же именно хранятся эти данные?</p>
<ul>
<li>Chromium(Windows): <code>C:\Users\%username%\AppData\Local\Google\Chrome\UserData\Default</code></li>
<li>Chromium(Linux): <code>/home/%username%/.config/google-chrome/Default</code></li>
<li>Firefox(Windows): <code>C:\Users\%username%\AppData\Roaming\Mozilla\Firefox\Profiles\$hash.default</code></li>
<li>Firefox(Linux): <code>/home/%username%/.mozilla/firefox/$hash.default/</code></li>
</ul>
<p>Критично важно хранить в защищенном месте по крайней мере пароли и кукисы. В действительности же браузеры защищают только пароли и то не всегда.</p>
<h2>Хранение паролей</h2>
<p>Для справки IE использует методы WinAPI <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa380261(v=vs.85).aspx">CryptProtectData</a> и CredentialManager. Благодаря этому методу файл с паролями хоть и хранится в определенном месте, но сами пароли там зашифрованы средствами ОС. CryptProtectData использует сведения о сессии Logon, поэтому только данный пользователь сможет расшифровать данные. К сожалению, если вирус уже окажется на компьютере, то он сам сможет распаковать от имени этого пользователя все файлы паролей и увезти их с собой.</p>
<p>Chromium хранит все пароли в каталоге <em>%PROFILE%/Login Data</em> — это файл sqlite базы данных. В этой БД хранятся адреса сайтов, соответственно логин-пароли, дата их создания и модификации, количество использований, url аватарки и так далее. Для шифрования паролей и только паролей в Windows используется <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/aa380261(v=vs.85).aspx">CryptProtectData</a>. А в Linux они по-умолчанию хранятся в открытом виде. И только если включен <a href="https://wiki.gnome.org/action/show/Projects/GnomeKeyring?action=show&#x26;redirect=GnomeKeyring">gnome keyring</a> или <a href="https://en.wikipedia.org/wiki/KWallet">kwallet</a>, то все данные из Login Data будут зашифрованы их средствами.</p>
<p>Интереснее обстоят дела с firefox. Там по умолчанию пароли шифруются алгоритмом 3des. В качестве ключа используются случайно сгененрированный файл <em>key3.db</em>, а сами пароли хранятся как blob объекты в <em>logins.json</em> или <em>signons.sqlite</em>. Злоумышленнику придется получить все эти файлы и знать как именно расшифровывать файл-паролей, но это конечно же не проблема. Но зато в firefox есть мастер-ключ, при установке которого добавляется соль в <em>key3.db</em> и тогда уже расшифровать без знания мастер пароля не получится ничего. По умолчанию мастер пароль просто равен пустой строке.</p>
<h2>Угрозы безопасности</h2>
<p>Для того чтобы оценить, какой из подходов защищает лучше всего, определим то от чего мы защищаемся. Я выделю следующие угрозы:</p>
<ol>
<li>Вредоносное ПО может получить всю папку с данными пользователя браузера. Похитить пароли, куки и файлы баз данных web-api. Проанализировать и скомпрометировать пользователя по истории браузера, кэшу и БД.</li>
<li>Любой пользователь ОС имея доступ к одной сессии может забрать весь каталог профиля и запустить у себя браузер от имени жертвы. Особенно актуально на рабочих местах, когда по политике безопасности предприятия на всех машинах строго определенные пароли и все их знают. Тогда средства шифрования, основанные на сессии строго говоря бессмысленны.</li>
</ol>
<p>Учитывая эти угрозы, можно считать наиболее защищенным от кражи паролей только cromium в linux/macOs с включенными менеджерами ключей, так как они всегда требуют пароль, независимо от сессии. А так же firefox с мастер паролем.</p>
<h2>Решение проблемы</h2>
<p>Итак, проблема — каталоги с пользовательскими данными во всех браузерах хранятся в строго определенных местах и не защищаются шифрованием. Самое простое, но далеко не изящное решение — это шифровать только эту папку средствами ОС или какими-то сторонними программами. Например, cryptkeeper или EFS в windows. В принципе, именно так я и решил проблему на текущий момент на своем рабочем компьютере. Также можно запускать хром внутри docker или виртуальном контейнере, в котором сама файловая система будет зашифрована. Эти методы защищают от второго типа угрозы, но к сожалению не от первого, так как расшифрованная папка существует как обычная примонтированная директория, т. е. ВПО так или иначе получит доступ к вашим файлам.</p>
<p>Если бы браузеры сами прозрачно для себя шифровали все файлы с которыми работали, тогда на ФС хранились бы только зашифрованные данные и не было бы момента времени, когда они существуют в открытом виде. Использование браузера и дополнительно программы для шифрования не так удобно для пользователя, как единый мастер пароль в браузере. Т.е. решение проблемы — это использовать профили браузера, а не операционной системы, прозрачно шифровать данные методами самого браузера, а не ОС. Такой подход, может несколько снизить производительность, а именно скорость работы IO браузера, но зато даст требуемый уровень защищенности.</p>
<h2>Зачем?</h2>
<p>Какие бонусы мы получим?</p>
<ol>
<li>Полную защищенность данных, начиная от истории браузера, заканчивая паролями и данными web-sql.</li>
<li>Можно будет использовать один браузер разным пользователям из-под одной сессии ОС.</li>
<li>Все куки будут привязаны к профилю браузера и не надо будет каждый раз при запуске браузера вводить пароли, как например в подходе с мастер ключом по паролю не зависимо от исполнения(ff, gnome-keyring, kde-wallet, osX keystore и др..), т.е. будет сохранённое зашифрованное состояние браузера.</li>
</ol>
<p>Возникает закономерный вопрос, почему же мейтнеры ни одного браузера не добавили такой функциональности? После некоторого исследования вопроса, я нашел рубрику вопросов-ответов по поводу безопасности в chromium. В основном там описываются вопросы безопасности со стороны веба. Но есть один интересный пункт: <a href="http://dev.chromium.org/Home/chromium-security/security-faq#TOC-Why-aren-t-physically-local-attacks-in-Chrome-s-threat-model-">«Why aren’t physically-local attacks in Chrome’s threat model?»</a>— <em>почему не рассматриваются физические атаки на хром в его модели безопасности</em>. Далее привожу мой перевод с пояснениями этого раздела.</p>
<blockquote>
<p>Пользователи иногда жалуются, что они могут компрометировать Chromium если установят вредоносное ПО или dll, или используют уязвимости в api. Мы(мейтнеры) считаем, что все эти уязвимости вне компетенции хромиума, мы не можем защищаться от вредоносного ПО, которое уже есть на вашем компьютере. Так как если кто-то уже получил доступ к вашему компьютеру и вашей сессии, то он сможет так же подменить dll у других приложений и вообще получить всю информацию, хранящуюся у вас на компьютере. Это не проблема хрома — в общем приложения должны доверять локальному пользователю. Чтобы уменьшить риск сторонними пользователями получить физический доступ к вашему компьютеру следуйте этим рекомендациям:</p>
<p>Используйте FDE — full disk encryption(полное шифрование диска). Используйте пароли и usb-ключи для расшифровывания диска. ChromeOS шифрует домашнюю директорию. Так же в своей ОС шифровать отдельные ресурсы.</p>
<p>Если вы разделяете компьютер с несколькими людьми, то пользуйтесь средствами ОС, такими как сессии и шифрование домашнего каталога.</p>
<p>Используйте блокировку экрана. (Очевидно)</p>
<p>Вы можете отключить сохранение пароля хромиумом, удалять все куки и чистить историю при выходе из хромиума.</p>
<p>Заметим, что невозможно избежать рисков на общедоступных компьютерах. Всё что хранится на таких компьютерах становится автоматически общедоступным. Используйте режим инкогнито на таких компьютерах.</p>
</blockquote>
<p>Исходя из политики хромиума, желаемой функции у них не появится никогда. И они действительно не считают это уязвимостью.</p>
<h2>Fork it</h2>
<p>А как тогда можно решить эту проблему, кроме описанных ранее интуитивно понятных способов? Единственным решением будет сделать форк браузера, хромиума или фаерфокса, и написать специальный патч, добавляющий такой функционал. Скорее всего его не подтвердят мейтнеры, так как он может усложнить интуитивность интерфейса браузера, но тем не менее можно распространять это решение как та же самая подключаемая библиотека dll с необходимым функционалом. Интересно рассмотреть tor-browser, он позиционируется как защищенный форк фаерфокса, так что в него могут включить этот патч.</p>
<p>Интерфейс браузера не сильно изменится, но появится менеджер сессии, как в ОС. При запуске браузера, пользователя попросят выбрать профиль, ввести мастер-пароль или подключить usb-ключ. Далее браузер построит ключ расшифрования и будет работать в прежнем режиме, думая что шифрования и нет. Таким образом предполагается патч подсистемы ввода-вывода браузера и добавление новых меню в UI.</p>
<p>В качестве целевого браузера, для которого я буду делать патч, я выбрал chromium. В принципе нет никакой разницы между firefox и chromium, но решающим фактором для выбора стало наличие исчерпывающей документации по исходному коду и проекту в целом у chromium. В любом случае подход, который я применю в одном браузере достаточно просто можно будет перенести на любой другой, так как в целом архитектура у них схожая.</p>
    </content>
  </div>
</article></main>
  </div>
</body>

</html>