<!DOCTYPE html>
<html lang="">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wazzup или “обман, выполненный мафией”</title>
  <meta name="description" content="" />
  <!-- Yandex.Metrika counter -->
<meta name="yandex-verification" content="721d8d42ba7b40bb" />
<script type="text/javascript" >
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
    m[i].l=1*new Date();
    for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
    k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
    (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");
 
    ym(91297055, "init", {
         clickmap:true,
         trackLinks:true,
         accurateTrackBounce:true
    });
 </script>
 <noscript><div><img src="https://mc.yandex.ru/watch/91297055" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
 <!-- /Yandex.Metrika counter -->

  <link rel="stylesheet" href="/styles/index.css">
  <link rel="stylesheet" href="/styles/katex.min.css">
</head>

<body>
  <header>
    <div class="logo">
      <a href="/">
        <!-- Awoo face generated using https://505e06b2.github.io/ -->
        <pre class="ascii-art">
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⢁⣿⡿⢡⣿⣿⣿⣿⢣⣿⣿⣿⣿⣿⢏⣼⣷⣦⡙⢃⣿⣿⣿⢸⣿⣿⣿⣿⣿⣿⣿⣿⡟⠟⣸⣿⡿⣡⣾⣿⡇⢸⣿⣿⡟⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣡⣾⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⣾⣿⡇⣿⣿⣿⣿⡇⣿⣿⣿⣿⣿⣡⣿⣿⣿⣿⠄⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠃⣨⣭⢉⣬⣤⣤⣬⡅⢸⣿⣿⢱⣿⣿⣿⣿⣿⣿⣿⣿⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡟⣡
⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⢰⣿⡟⠄⣿⣿⣿⣿⣿⣿⣿⣿⢿⢫⣿⣿⣿⣿⣿⣼⣿⣿⣿⣿⡇⣿⣿⣿⣿⣿⣿⠟⣡⢡⡿⢣⣿⣿⣿⣿⣿⡇⢸⣿⡟⣼⣿⣿⣿⣿⣿⣿⣿⣿⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⢫⣾⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⣾⣿⢁⣏⢻⣿⣿⣿⢸⣿⣿⣧⢀⣀⣁⡀⠉⠙⠻⢿⣿⣿⣿⣿⣧⢹⣿⣿⣿⣿⠏⣼⢇⠟⣴⣿⣿⣿⣿⣿⣿⣧⢸⣿⢰⣿⣿⣿⣿⣿⣿⣿⣿⡟⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⢋⣴⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⠁⣿⡏⣼⡿⣿⣿⣿⣿⢸⣿⣿⢃⣾⣿⣿⣿⠿⠖⠒⠄⣈⣿⣿⣿⣿⣆⢻⣿⣿⠏⣾⣟⣼⠞⠛⡋⠉⠉⠉⠉⠉⠉⠘⠃⠻⣿⣿⣿⣿⣿⣿⣿⣿⢱⣿⣿⣿⣿⣿⣿⣿⣿⢋⣽⣶⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⢸⣿⢡⣿⡇⣿⣿⣿⡿⢸⡿⢇⣾⣟⣋⣉⣤⣤⣶⣾⣿⣿⣿⣿⣿⣿⣿⣎⡿⣋⣾⣿⣿⣿⣦⣄⡈⠙⠿⠿⣿⣿⣿⠈⣾⣿⣿⣿⣿⣿⣿⣿⣿⢇⣿⣿⣿⣿⣿⣿⠿⢟⣡⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⢸⡇⣼⣿⡇⢿⣿⣿⠇⢸⡗⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣽⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣦⣄⠄⠈⠹⡏⣄⣿⣿⣿⣿⣿⣿⣿⣿⣇⣾⣿⣿⣿⡿⠟⣥⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⡿⠸⠡⣿⣿⣟⠸⣿⣿⢸⢸⠷⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣶⡄⣠⣽⣿⣿⣿⣿⣿⣿⣿⡿⣹⣿⣿⣿⣿⠇⢉⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
⣿⣿⣿⣿⣿⣿⣿⣿⣿⠸⢰⣿⣿⣿⡆⢿⣿⢸⣸⣧⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⢹⣿⣿⣿⣿⣿⣿⣿⣿⡿⣱⡿⠟⣋⣥⠖⣱⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
</pre>
      </a>
    </div>
    <table>
      <tbody>
        <tr>
          <td style="width: 33%;"><a href="/teaching">Курсы</a></td>
          <td style="width: 33%;"><a href="/notes">Заметки</a></td>
          <td style="width: 33%;"><a href="/talks">Выступления</a></td>
        </tr>
      </tbody>
    </table>
  </header>

  <div>
    <main>
<article>
  <div>
    <h1>Wazzup или “обман, выполненный мафией”</h1>
    <time datetime="2016-01-24">24 Jan 2016</time>
  </div>

  <div id="notes-entry-container">
    <content>
      <blockquote>
<p>TL;DR; Описание фишинговой атаки на WhatsApp.</p>
</blockquote>
<p>Последнее время я все чаще вижу как сервисы внедряют у себя беспарольную (passwordless) аутентификацию. Всем стало уже привычно использовать SMS коды для входа в telegram, viber, etc… Но некоторые ребята идут еще дальше — внедряют QR-коды для входа в веб-версию их приложения. Не будем ходить далеко за примером, возьмем WhatsApp. Вот страница входа <a href="https://web.whatsapp.com/">web.whatsapp.com</a>. Чтобы аутентифицировать себя в системе нужно отсканировать QR-код через приложение WhatsApp и, вуяля, вы вошли в веб версию чата. Вау-эффект гарантирован. Да и выглядит это безопаснее — не надо вводить пароли, и удобнее — не нужно ждать SMS.</p>
<p>С такими новыми системами появляется иллюзорное ощущение, что вот теперь мы действительно находимся в безопасности. Никто не украдет пароль от аккаунта, так как пароля не существует в принципе. Кажется, что даже <a href="https://ru.wikipedia.org/wiki/%D0%A4%D0%B8%D1%88%D0%B8%D0%BD%D0%B3">фишинг</a> нам не страшен!(т.е. заманивание жертвы в ловушку так, чтобы она ввела свой пароль куда не надо)</p>
<p>Но что если я вам скажу, что и здесь есть вектор атаки. Можно угнать аккаунт, хотя бы на несколько секунд, пока жертва не заметит неладное. Но прежде всего расскажу теорию.</p>
<h2>“Проблема гроссмейстера”</h2>
<p>Мэллори не умеет играть в шахматы. Но ради славы и зрелища она объявила турнир в шахматы сразу двум великим гроссмейстерам — Алисе и Бобу. И играть она будет против двух мастеров ОДНОВРЕМЕННО, точно так же как Остап Бендер против Васюков. С Алисой он будет играть черными, а с Бобом — белыми. И как вы уже догадались, будет копировать ходы Алисы и Боба в партиях. То есть по факту Алиса будет играть против Боба, через посредника.</p>
<p>Как результат этого получаем обман, выполненный мафией.</p>
<h2>“Обман, выполненный мафией”</h2>
<p>В городе обитает мафия. Одного из представителей зовут Ева, и она держит милый ресторанчик в центре города. Второго — Мэллори; он любит работать в “поле”. Так же из действующих лиц у нас есть Боб, заведующий ювелирным магазином на окраине города.</p>
<p>Доверчивая девушка Алиса пошла на бизнес ланч в ресторан “У Евы”. В этот же самый момент, как и договаривались Ева и Мэллори, Мэллори отправился в ювелирный магазин Боба. После чудесной трапезы Алиса подходит к кассе и по особому протоколу начинает доказывать, что она та за кого себя выдает и что мы можем снять с её счета деньги. В этот же самый момент Ева в тайне от Алисы передает ей все шаги доказательства Мэллори. Он в свою очередь в магазине Боба выдает себя за Алису, используя её доказательство и снимает кучу денег покупая дорогое кольцо. Профит!</p>
<p>“И как же это связано с WhatsApp,— спросите вы. На что я отвечу: “Непосредственно”. Распишем роли: WhatsApp — Боб, приложение в нашем смартфоне — Алиса, фишинговый сайт — Мэллори и Ева.</p>
<h2>Эксплуатируем уязвимость!</h2>
<p><img src="/assets/wazzup/1_mrpcrOON2mZZK_ZqqPcjAw.png" alt="Сценарий"></p>
<ol>
<li>Жертва заходит на фишинговый сайт, как две капли воды похожий на оригинальный <a href="https://web.whatsapp.com/">WhatsApp</a>.</li>
<li>Жертва видит знакомый ей QR-код и приглашение сканировать его приложением, что она и делает.</li>
<li>Каким-то чудом оказывается, что жертва аутентифицровала сессию злоумышленника.</li>
</ol>
<p>Как же все это провернуть? Оказывается очень просто. Для этого нам понадобится:</p>
<ol>
<li><a href="http://www.seleniumhq.org/">Selenium Web driver</a>, нужный для получения QR-кода из WhatsApp.</li>
<li><a href="https://github.com/blan4/Wazzup">Простенький сервер,</a> который будет запускать селениум и передавать полученный код на фишинговую страницу.</li>
</ol>
<p><img src="/assets/wazzup/1_RzGToCt2Y_LlLAifwnf7-g.png" alt="Пруф концепта на скриншотах"></p>
<p>Жертва заходит на <a href="http://localhost:4567/">http://localhost:4567</a> — это сайт злоумышленника. В этот момент запускается selenium и открывает сессию с <a href="https://web.whatsapp.com/">https://web.whatsapp.com</a>. Специальный скрипт ищет на странице QR-code и отправляет его жертве.</p>
<h2>Недостатки</h2>
<ol>
<li>Жертва заметит неладное и сразу же нажмет на смартфоне кнопку “выйти со всех устройств”. Но до этого времени будет секунд 5–10 чтобы сделать грязные делишки.</li>
<li>Время ожидания загрузки фейковой странице в два раза больше, чем у оригинального сайта.</li>
</ol>
<h2>Заключение</h2>
<p>Вы конечно ради интереса можете ознакомится с исходниками сервера, который делает что-то подобное. Там нет ничего страшного, строчек <a href="https://github.com/senior-sigan/Wazzup">30 джава кода</a>.</p>
<p>Да и в описанной уязвимости нет ничего неожиданного. Это очевидная проблема систем “нулевого разглашения” и подобных.</p>
<p>Что можно сделать, чтобы в вашем супер сервисе не было даже таких проблем? Единственное что мне пришло в голову — это после сканирования кода показывать пользователю уведомление “запрос на вход был произведен с такого-то user-agent (но его можно подменить😕) и с такого-то IP-адреса и локации (города)”.</p>
<p>Но как известно, <em>абсолютно защищенная система абсолютно не работает.</em></p>
    </content>
  </div>
</article></main>
  </div>
</body>

</html>